// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANT & USER MANAGEMENT
// ============================================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  status    TenantStatus @default(ACTIVE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users               User[]
  twilioNumbers       TwilioNumber[]
  departments         Department[]
  transferTargets     TransferTarget[]
  receptionistConfig  ReceptionistConfig?
  businessHours       BusinessHours[]
  holidayHours        HolidayHours[]
  knowledgeBase       KnowledgeBaseEntry[]
  faqs                FAQ[]
  callFlows           CallFlow[]
  callSessions        CallSession[]
  leads               Lead[]
  websiteSources      WebsiteSource[]
  auditLogs           AuditLog[]

  @@index([slug])
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  DISABLED
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String?
  lastName  String?
  role      UserRole @default(TENANT_ADMIN)
  tenantId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  auditLogs AuditLog[]

  @@index([email])
  @@index([tenantId])
}

enum UserRole {
  SUPER_ADMIN
  TENANT_ADMIN
  TENANT_USER
}

// ============================================
// TWILIO & PHONE CONFIGURATION
// ============================================

model TwilioNumber {
  id          String   @id @default(uuid())
  tenantId    String
  phoneNumber String   @unique  // E.164 format: +15551234567
  friendlyName String?
  sid         String?  @unique  // Twilio Phone Number SID
  status      PhoneStatus @default(ACTIVE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  callSessions CallSession[]

  @@index([tenantId])
  @@index([phoneNumber])
}

enum PhoneStatus {
  ACTIVE
  INACTIVE
}

model Department {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transferTargets TransferTarget[]

  @@index([tenantId])
}

model TransferTarget {
  id           String   @id @default(uuid())
  tenantId     String
  departmentId String?
  name         String
  phoneNumber  String   // E.164 format
  priority     Int      @default(1)  // Lower = higher priority
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([departmentId])
}

// ============================================
// RECEPTIONIST CONFIGURATION
// ============================================

model ReceptionistConfig {
  id                    String   @id @default(uuid())
  tenantId              String   @unique
  greetingMessage       String   @default("Thank you for calling. This call may be recorded for quality assurance. You are speaking with an automated assistant. How can I help you today?")
  personality           String   @default("professional, friendly, and helpful")
  voiceModel            String   @default("en-US-Neural2-F")  // For future TTS integration
  transferPrompt        String   @default("Let me connect you with someone who can help. Please hold.")
  leadCapturePrompt     String   @default("I'd be happy to have someone call you back. Can I get your name and phone number?")
  fallbackMessage       String   @default("I'm sorry, I didn't understand that. Could you please repeat?")
  endCallMessage        String   @default("Thank you for calling. Have a great day!")
  maxSilentRetries      Int      @default(3)
  maxTurns              Int      @default(20)
  enableRecording       Boolean  @default(true)
  enableLeadCapture     Boolean  @default(true)
  
  // IVR and Flow Settings
  enableIVR             Boolean  @default(false)
  ivrMenuPrompt         String?  @db.Text  // Main menu prompt
  enableVoicemail       Boolean  @default(true)
  voicemailPrompt       String?  @db.Text  // Voicemail greeting
  voicemailFlowEnabled  Boolean  @default(false)  // AI handles voicemail
  menuOptionDelayMs     Int      @default(2000)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  ivrMenuOptions IVRMenuOption[]

  @@index([tenantId])
}

model IVRMenuOption {
  id                    String   @id @default(uuid())
  receptionistConfigId  String
  digit                 String   // "1", "2", "3", etc.
  label                 String   // "Texas Location", "Arizona Location"
  action                IVRAction @default(AI_MODE)
  transferNumber        String?  // Phone number to transfer to
  departmentId          String?  // Department to route to
  customMessage         String?  @db.Text // Custom message before action
  order                 Int      @default(1)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  receptionistConfig ReceptionistConfig @relation(fields: [receptionistConfigId], references: [id], onDelete: Cascade)

  @@unique([receptionistConfigId, digit])
  @@index([receptionistConfigId])
}

enum IVRAction {
  AI_MODE        // Continue to AI receptionist
  TRANSFER       // Transfer to specific number
  DEPARTMENT     // Route to department
  VOICEMAIL      // Go to voicemail
  CUSTOM_MESSAGE // Play message and end
}

model BusinessHours {
  id        String   @id @default(uuid())
  tenantId  String
  dayOfWeek Int      // 0=Sunday, 6=Saturday
  openTime  String   // HH:MM format, e.g., "09:00"
  closeTime String   // HH:MM format, e.g., "17:00"
  isOpen    Boolean  @default(true)
  timezone  String   @default("America/Los_Angeles")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, dayOfWeek])
  @@index([tenantId])
}

model HolidayHours {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  date        DateTime @db.Date
  isClosed    Boolean  @default(true)
  openTime    String?
  closeTime   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([date])
}

// ============================================
// KNOWLEDGE BASE
// ============================================

model KnowledgeBaseEntry {
  id          String   @id @default(uuid())
  tenantId    String
  category    String   // e.g., "hours", "pricing", "services"
  question    String
  answer      String   @db.Text
  keywords    String[] // For search matching
  isActive    Boolean  @default(true)
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([category])
}

// FAQ - Frequently Asked Questions
model FAQ {
  id          String   @id @default(uuid())
  tenantId    String
  question    String
  answer      String   @db.Text
  category    String?  // Optional grouping
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([category])
}

// Call Flow Configuration
model CallFlow {
  id          String   @id @default(uuid())
  tenantId    String
  name        String   // e.g., "Main Menu", "After Hours", "Voicemail Flow"
  flowType    FlowType @default(MAIN_MENU)
  isActive    Boolean  @default(true)
  priority    Int      @default(0)
  
  // Flow Configuration (JSON structure)
  config      Json     // Stores the flow steps and logic
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([flowType])
}

enum FlowType {
  MAIN_MENU      // Initial call greeting and menu
  AFTER_HOURS    // When business is closed
  NO_ANSWER      // When transfer/call isn't answered
  VOICEMAIL      // Direct to voicemail
  DEPARTMENT     // Department-specific menu (Sales, Service, etc.)
  CUSTOM         // Custom flow for special cases
}

// ============================================
// CALL MANAGEMENT
// ============================================

model CallSession {
  id              String      @id @default(uuid())
  tenantId        String
  twilioNumberId  String
  callSid         String      @unique
  fromNumber      String
  toNumber        String
  status          CallStatus  @default(IN_PROGRESS)
  state           CallState   @default(GREETING)
  direction       String      @default("inbound")
  startTime       DateTime    @default(now())
  endTime         DateTime?
  duration        Int?        // seconds
  recordingUrl    String?
  recordingSid    String?
  transferAttempted Boolean   @default(false)
  transferSuccess   Boolean   @default(false)
  leadCaptured    Boolean     @default(false)
  metadata        Json?       // Store additional call data (IVR selection, etc.)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  twilioNumber TwilioNumber  @relation(fields: [twilioNumberId], references: [id], onDelete: Cascade)
  events       CallEvent[]
  recordings   Recording[]
  transcript   Transcript?
  summary      CallSummary?
  lead         Lead?

  @@index([tenantId])
  @@index([callSid])
  @@index([fromNumber])
  @@index([startTime])
}

enum CallStatus {
  IN_PROGRESS
  COMPLETED
  FAILED
  BUSY
  NO_ANSWER
  CANCELED
}

enum CallState {
  GREETING
  INTENT
  FAQ
  TRANSFER_ATTEMPT
  LEAD_CAPTURE
  CONFIRMATION
  WRAP_UP
  ENDED
}

model CallEvent {
  id            String   @id @default(uuid())
  callSessionId String
  eventType     String   // e.g., "state_change", "user_input", "ai_response"
  state         CallState?
  data          String   @db.Text // JSON
  timestamp     DateTime @default(now())

  // Relations
  callSession CallSession @relation(fields: [callSessionId], references: [id], onDelete: Cascade)

  @@index([callSessionId])
  @@index([timestamp])
}

model Recording {
  id            String   @id @default(uuid())
  callSessionId String
  recordingSid  String   @unique
  url           String
  duration      Int?     // seconds
  createdAt     DateTime @default(now())

  // Relations
  callSession CallSession @relation(fields: [callSessionId], references: [id], onDelete: Cascade)

  @@index([callSessionId])
}

model Transcript {
  id            String   @id @default(uuid())
  callSessionId String   @unique
  fullText      String   @db.Text
  turns         String   @db.Text // JSON array of {speaker, text, timestamp}
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  callSession CallSession @relation(fields: [callSessionId], references: [id], onDelete: Cascade)

  @@index([callSessionId])
}

model CallSummary {
  id            String   @id @default(uuid())
  callSessionId String   @unique
  intent        String?
  summary       String   @db.Text
  sentiment     String?  // positive, neutral, negative
  actionItems   String[] 
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  callSession CallSession @relation(fields: [callSessionId], references: [id], onDelete: Cascade)

  @@index([callSessionId])
}

// ============================================
// LEAD MANAGEMENT
// ============================================

model Lead {
  id              String     @id @default(uuid())
  tenantId        String
  callSessionId   String?    @unique
  name            String?
  phone           String?
  email           String?
  reason          String?    @db.Text
  callbackPreference String?
  status          LeadStatus @default(NEW)
  source          String     @default("voice_call")
  notes           String?    @db.Text
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relations
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  callSession CallSession? @relation(fields: [callSessionId], references: [id], onDelete: SetNull)
  customFields LeadField[]

  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
}

model LeadField {
  id        String   @id @default(uuid())
  leadId    String
  label     String   // The question label (e.g., "Company Name", "Budget")
  value     String   @db.Text
  order     Int      @default(0)
  createdAt DateTime @default(now())

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  CLOSED
}

// ============================================
// BACKGROUND JOBS
// ============================================

model Job {
  id          String    @id @default(uuid())
  type        String    // e.g., "send_email", "summarize_call"
  payload     String    @db.Text // JSON
  status      JobStatus @default(PENDING)
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  error       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  scheduledAt DateTime?
  processedAt DateTime?

  @@index([status])
  @@index([type])
  @@index([scheduledAt])
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================
// WEBSITE SCRAPING & RAG (Retrieval Augmented Generation)
// ============================================

model WebsiteSource {
  id          String   @id @default(uuid())
  tenantId    String
  domain      String   // e.g., "example.com"
  url         String   // Full URL: https://example.com
  status      ScrapeStatus @default(PENDING)
  pagesFound  Int      @default(0)
  pagesScraped Int     @default(0)
  lastScrapedAt DateTime?
  errorMessage String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contents WebsiteContent[]

  @@index([tenantId])
  @@index([domain])
  @@index([status])
}

enum ScrapeStatus {
  PENDING
  SCRAPING
  COMPLETED
  FAILED
}

model WebsiteContent {
  id            String   @id @default(uuid())
  websiteSourceId String
  tenantId      String
  url           String   // Page URL
  title         String?
  content       String   @db.Text  // Chunked text content
  chunkIndex    Int      @default(0)  // Which chunk this is (for pages split into multiple chunks)
  tokenCount    Int      @default(0)
  embedding     Unsupported("vector(1536)")?  // OpenAI embedding (1536 dimensions)
  metadata      Json?    // Additional metadata (headers, links, etc.)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  websiteSource WebsiteSource @relation(fields: [websiteSourceId], references: [id], onDelete: Cascade)

  @@index([websiteSourceId])
  @@index([tenantId])
  @@index([url])
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id        String   @id @default(uuid())
  tenantId  String?
  userId    String?
  action    String
  resource  String
  resourceId String?
  details   String?  @db.Text // JSON
  ipAddress String?
  timestamp DateTime @default(now())

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([userId])
  @@index([timestamp])
}
