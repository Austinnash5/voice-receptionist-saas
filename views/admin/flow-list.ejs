<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Call Flows - <%= tenant.name %></title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .flow-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .flow-card {
      background: white;
      border: 1px solid #e1e4e8;
      border-radius: 8px;
      padding: 1.5rem;
      transition: all 0.2s;
      position: relative;
    }

    .flow-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    .flow-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .flow-type-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .flow-type-MAIN_MENU { background: #e3f2fd; color: #1565c0; }
    .flow-type-AFTER_HOURS { background: #f3e5f5; color: #6a1b9a; }
    .flow-type-NO_ANSWER { background: #fff3e0; color: #e65100; }
    .flow-type-VOICEMAIL { background: #e8f5e9; color: #2e7d32; }
    .flow-type-DEPARTMENT { background: #fce4ec; color: #c2185b; }
    .flow-type-CUSTOM { background: #f5f5f5; color: #616161; }

    .flow-card-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 0.5rem 0;
      color: #24292e;
    }

    .flow-card-meta {
      font-size: 0.875rem;
      color: #586069;
      margin: 0.5rem 0;
    }

    .flow-card-stats {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #e1e4e8;
    }

    .flow-stat {
      flex: 1;
      text-align: center;
    }

    .flow-stat-value {
      display: block;
      font-size: 1.5rem;
      font-weight: 600;
      color: #0366d6;
    }

    .flow-stat-label {
      display: block;
      font-size: 0.75rem;
      color: #586069;
      margin-top: 0.25rem;
    }

    .flow-card-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .flow-card-actions .btn {
      flex: 1;
      font-size: 0.875rem;
      padding: 0.5rem 0.75rem;
    }

    .toggle-active {
      position: absolute;
      top: 1rem;
      right: 1rem;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: #28a745;
    }

    input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: #f6f8fa;
      border-radius: 8px;
      margin-top: 2rem;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .empty-state h3 {
      font-size: 1.5rem;
      margin: 0 0 0.5rem 0;
      color: #24292e;
    }

    .empty-state p {
      color:  #586069;
      margin: 0 0 2rem 0;
    }

    .info-callout {
      background: #e7f3ff;
      border-left: 4px solid #0366d6;
      padding: 1rem 1.5rem;
      margin: 1.5rem 0;
      border-radius: 4px;
    }

    .info-callout h4 {
      margin: 0 0 0.5rem 0;
      color: #0366d6;
      font-size: 1rem;
    }

    .info-callout ul {
      margin: 0;
      padding-left: 1.5rem;
    }

    .info-callout li {
      margin: 0.25rem 0;
      color: #24292e;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <div class="nav-brand">
        <a href="/">ü§ñ AI Voice Receptionist</a>
      </div>
      <ul class="nav-menu">
        <li><a href="/admin/dashboard">Dashboard</a></li>
        <li><a href="/admin/tenants">Tenants</a></li>
        <li><a href="/admin/numbers">Phone Numbers</a></li>
        <li class="user-menu">
          <span><%= user.email %></span>
          <a href="/logout" class="btn btn-sm">Logout</a>
        </li>
      </ul>
    </div>
  </nav>

  <main class="main-content">
    <div class="container">
      <div class="page-header">
        <div>
          <h1>üìû Call Flows - <%= tenant.name %></h1>
          <p class="subtitle">Create intelligent call routing and IVR menus</p>
        </div>
        <div style="display: flex; gap: 1rem;">
          <a href="/admin/tenants/<%= tenant.id %>" class="btn btn-secondary">‚Üê Back to Tenant</a>
          <a href="/admin/tenants/<%= tenant.id %>/flows/new" class="btn btn-primary">+ Create New Flow</a>
        </div>
      </div>

      <div class="info-callout">
        <h4>üí° What are Call Flows?</h4>
        <p>Call flows let you create phone menus and routing logic without writing code:</p>
        <ul>
          <li><strong>Main Menu:</strong> Initial greeting when someone calls (e.g., "Press 1 for Sales...")</li>
          <li><strong>After Hours:</strong> Special message when you're closed</li>
          <li><strong>No Answer:</strong> What happens when a transfer isn't answered</li>
          <li><strong>Department Menus:</strong> Custom menus for Sales, Service, etc.</li>
        </ul>
      </div>

      <div id="flowsContainer">
        <div style="text-align: center; padding: 3rem;">
          <div class="spinner"></div>
          <p>Loading flows...</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    const tenantId = '<%= tenant.id %>';
    let flows = [];

    // Load flows on page load
    document.addEventListener('DOMContentLoaded', loadFlows);

    async function loadFlows() {
      try {
        const response = await fetch(`/api/tenants/${tenantId}/flows`);
        
        if (!response.ok) {
          throw new Error('Failed to load flows');
        }

        flows = await response.json();
        renderFlows();
      } catch (error) {
        console.error('Error loading flows:', error);
        document.getElementById('flowsContainer').innerHTML = `
          <div class="alert alert-error">
            Failed to load flows. Please refresh the page.
          </div>
        `;
      }
    }

    function renderFlows() {
      const container = document.getElementById('flowsContainer');

      if (flows.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìû</div>
            <h3>No Call Flows Yet</h3>
            <p>Create your first call flow to start routing calls intelligently!</p>
            <a href="/admin/tenants/${tenantId}/flows/new" class="btn btn-primary btn-lg">Create Your First Flow</a>
          </div>
        `;
        return;
      }

      let html = '<div class="flow-grid">';

      flows.forEach(flow => {
        const config = typeof flow.config === 'string' ? JSON.parse(flow.config) : flow.config;
        const stepCount = config.steps ? config.steps.length : 0;

        html += `
          <div class="flow-card">
            <div class="toggle-active">
              <label class="toggle-switch">
                <input type="checkbox" ${flow.isActive ? 'checked' : ''} onchange="toggleFlow('${flow.id}')">
                <span class="toggle-slider"></span>
              </label>
            </div>
            
            <div class="flow-card-header">
              <div>
                <span class="flow-type-badge flow-type-${flow.flowType}">${formatFlowType(flow.flowType)}</span>
              </div>
            </div>

            <h3 class="flow-card-title">${escapeHtml(flow.name)}</h3>
            <p class="flow-card-meta">
              ${flow.isActive ? '‚úÖ Active' : '‚è∏Ô∏è Inactive'} ‚Ä¢ Priority: ${flow.priority}
            </p>

            <div class="flow-card-stats">
              <div class="flow-stat">
                <span class="flow-stat-value">${stepCount}</span>
                <span class="flow-stat-label">Step${stepCount !== 1 ? 's' : ''}</span>
              </div>
            </div>

            <div class="flow-card-actions">
              <a href="/admin/tenants/${tenantId}/flows/${flow.id}/edit" class="btn btn-secondary">
                ‚úèÔ∏è Edit
              </a>
              <button onclick="duplicateFlow('${flow.id}')" class="btn btn-secondary">
                üìã Duplicate
              </button>
              <button onclick="deleteFlow('${flow.id}', '${escapeHtml(flow.name)}')" class="btn btn-danger">
                üóëÔ∏è Delete
              </button>
            </div>
          </div>
        `;
      });

      html += '</div>';
      container.innerHTML = html;
    }

    function formatFlowType(type) {
      return type.replace(/_/g, ' ');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function toggleFlow(flowId) {
      try {
        const response = await fetch(`/api/flows/${flowId}/toggle`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        if (!response.ok) {
          throw new Error('Failed to toggle flow');
        }

        await loadFlows();
      } catch (error) {
        console.error('Error toggling flow:', error);
        alert('Failed to toggle flow status');
        await loadFlows();
      }
    }

    async function duplicateFlow(flowId) {
      if (!confirm('Create a copy of this flow?')) return;

      try {
        const response = await fetch(`/api/flows/${flowId}/duplicate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        if (!response.ok) {
          throw new Error('Failed to duplicate flow');
        }

        await loadFlows();
        alert('Flow duplicated successfully!');
      } catch (error) {
        console.error('Error duplicating flow:', error);
        alert('Failed to duplicate flow');
      }
    }

    async function deleteFlow(flowId, flowName) {
      if (!confirm(`Are you sure you want to delete "${flowName}"?\n\nThis action cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch(`/api/flows/${flowId}`, {
          method: 'DELETE',
        });

        if (!response.ok) {
          throw new Error('Failed to delete flow');
        }

        await loadFlows();
        alert('Flow deleted successfully');
      } catch (error) {
        console.error('Error deleting flow:', error);
        alert('Failed to delete flow');
      }
    }
  </script>
</body>
</html>
