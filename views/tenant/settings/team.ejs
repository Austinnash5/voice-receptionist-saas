<!DOCTYPE html>
<html>
<head>
  <title>Team Members</title>
</head>
<body>
  <%- include('../../layout', { 
    user, 
    activeApp: 'crm',
    userPermissions: permissions || [],
    body: `
    <div class="page-header">
      <h1>Team Members</h1>
      <div class="header-actions">
        ${permissions.includes('users:manage') ? `<button onclick="openInviteModal()" class="btn btn-primary">+ Invite Member</button>` : ''}
      </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üë•</div>
        <div class="stat-value">${stats?.totalUsers || users?.length || 0}</div>
        <div class="stat-label">Total Members</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-value">${stats?.activeUsers || 0}</div>
        <div class="stat-label">Active</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚è∏Ô∏è</div>
        <div class="stat-value">${stats?.inactiveUsers || 0}</div>
        <div class="stat-label">Inactive</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üé≠</div>
        <div class="stat-value">${stats?.totalRoles || roles?.length || 0}</div>
        <div class="stat-label">Roles</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-bar">
      <form method="GET" action="/tenant/settings/team">
        <input type="text" name="search" placeholder="Search members..." value="${search || ''}">
        
        <select name="roleId">
          <option value="">All Roles</option>
          ${roles ? roles.map(r => `<option value="${r.id}" ${roleId === r.id ? 'selected' : ''}>${r.name}</option>`).join('') : ''}
        </select>

        <select name="isActive">
          <option value="">All Status</option>
          <option value="true" ${isActive === 'true' ? 'selected' : ''}>Active</option>
          <option value="false" ${isActive === 'false' ? 'selected' : ''}>Inactive</option>
        </select>

        <button type="submit" class="btn btn-primary">Filter</button>
        ${(search || roleId || isActive) ? `<a href="/tenant/settings/team" class="btn btn-secondary">Clear</a>` : ''}
      </form>
    </div>

    <!-- Users Table -->
    ${users && users.length > 0 ? `
    <div class="data-table">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Status</th>
            <th>Last Login</th>
            <th>Invited By</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${users.map(u => `
          <tr>
            <td>
              <div class="user-cell">
                <div class="user-avatar">${getInitials(u.firstName + ' ' + u.lastName)}</div>
                <div>
                  <div class="user-name">${u.firstName} ${u.lastName}</div>
                  ${u.id === user.id ? '<span class="badge badge-primary">You</span>' : ''}
                </div>
              </div>
            </td>
            <td>${u.email}</td>
            <td>
              ${u.role ? `<span class="role-badge">${u.role.name}</span>` : 'No Role'}
            </td>
            <td>
              <span class="badge badge-${u.isActive ? 'success' : 'secondary'}">
                ${u.isActive ? 'Active' : 'Inactive'}
              </span>
            </td>
            <td>${u.lastLoginAt ? new Date(u.lastLoginAt).toLocaleDateString() : 'Never'}</td>
            <td>${u.invitedBy ? u.invitedBy.firstName + ' ' + u.invitedBy.lastName : '-'}</td>
            <td class="table-actions">
              ${permissions.includes('users:manage') && u.id !== user.id ? `
              <button onclick="editUser('${u.id}')" title="Edit Role">‚úèÔ∏è</button>
              ${u.isActive ? `
              <button onclick="deactivateUser('${u.id}')" title="Deactivate">‚è∏Ô∏è</button>
              ` : `
              <button onclick="reactivateUser('${u.id}')" title="Reactivate">‚ñ∂Ô∏è</button>
              `}
              ` : ''}
            </td>
          </tr>
          `).join('')}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination">
      <a href="?page=${Math.max(1, (page || 1) - 1)}${getQueryString()}" class="btn btn-secondary" ${(page || 1) <= 1 ? 'disabled' : ''}>Previous</a>
      <span>Page ${page || 1}</span>
      <a href="?page=${(page || 1) + 1}${getQueryString()}" class="btn btn-secondary" ${users.length < (limit || 50) ? 'disabled' : ''}>Next</a>
    </div>
    ` : `
    <div class="empty-state">
      <div class="empty-icon">üë•</div>
      <p>No team members yet</p>
      ${permissions.includes('users:manage') ? `<button onclick="openInviteModal()" class="btn btn-primary">Invite First Member</button>` : ''}
    </div>
    `}

    <!-- Invite Modal -->
    <div id="inviteModal" class="modal">
      <div class="modal-content">
        <h2>Invite Team Member</h2>
        <form id="inviteForm" onsubmit="inviteUser(event)">
          <div class="form-group">
            <label for="inviteEmail">Email Address <span class="required">*</span></label>
            <input type="email" id="inviteEmail" name="email" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="inviteFirstName">First Name <span class="required">*</span></label>
              <input type="text" id="inviteFirstName" name="firstName" required>
            </div>
            
            <div class="form-group">
              <label for="inviteLastName">Last Name <span class="required">*</span></label>
              <input type="text" id="inviteLastName" name="lastName" required>
            </div>
          </div>

          <div class="form-group">
            <label for="inviteRoleId">Role <span class="required">*</span></label>
            <select id="inviteRoleId" name="roleId" required>
              <option value="">-- Select Role --</option>
              ${roles ? roles.map(r => `<option value="${r.id}">${r.name}</option>`).join('') : ''}
            </select>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeInviteModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Send Invite</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      function getInitials(name) {
        if (!name) return '?';
        return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
      }

      function getQueryString() {
        const params = new URLSearchParams(window.location.search);
        params.delete('page');
        return params.toString() ? '&' + params.toString() : '';
      }

      function openInviteModal() {
        document.getElementById('inviteModal').style.display = 'flex';
      }

      function closeInviteModal() {
        document.getElementById('inviteModal').style.display = 'none';
        document.getElementById('inviteForm').reset();
      }

      function inviteUser(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData);

        fetch('/api/users/invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        }).then(async response => {
          if (response.ok) {
            const result = await response.json();
            alert(\`User invited successfully! Temporary password: \${result.tempPassword}\nPlease share this with the user securely.\`);
            location.reload();
          } else {
            const error = await response.json();
            alert('Failed to invite user: ' + (error.error || 'Unknown error'));
          }
        }).catch(err => {
          alert('Error inviting user: ' + err.message);
        });
      }

      function editUser(userId) {
        const roleId = prompt('Enter new role ID (or leave blank to keep current):');
        if (roleId !== null && roleId !== '') {
          fetch(\`/api/users/\${userId}\`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ roleId })
          }).then(response => {
            if (response.ok) {
              alert('User updated successfully');
              location.reload();
            } else {
              alert('Failed to update user');
            }
          });
        }
      }

      function deactivateUser(userId) {
        if (confirm('Are you sure you want to deactivate this user?')) {
          fetch(\`/api/users/\${userId}/deactivate\`, {
            method: 'POST'
          }).then(response => {
            if (response.ok) {
              location.reload();
            } else {
              alert('Failed to deactivate user');
            }
          });
        }
      }

      function reactivateUser(userId) {
        if (confirm('Are you sure you want to reactivate this user?')) {
          fetch(\`/api/users/\${userId}/reactivate\`, {
            method: 'POST'
          }).then(response => {
            if (response.ok) {
              location.reload();
            } else {
              alert('Failed to reactivate user');
            }
          });
        }
      }

      // Close modal when clicking outside
      window.onclick = function(event) {
        const modal = document.getElementById('inviteModal');
        if (event.target === modal) {
          closeInviteModal();
        }
      }
    </script>

    <style>
      .user-cell {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
      }

      .user-name {
        font-weight: 600;
        margin-bottom: 2px;
      }

      .role-badge {
        background: #e8f4ff;
        color: #0066cc;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 500;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: white;
        border-radius: 8px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-content h2 {
        margin: 0 0 20px 0;
        font-size: 22px;
      }
    </style>
    `
  }) %>
</body>
</html>
