<!DOCTYPE html>
<html>
<head>
  <title>Companies</title>
</head>
<body>
  <%- include('../../layout', { 
    user, 
    activeApp: 'crm',
    userPermissions: permissions || [],
    body: `
    <div class="page-header">
      <h1>Companies</h1>
      <div class="header-actions">
        ${permissions.includes('crm:create') ? `<a href="/tenant/crm/companies/new" class="btn btn-primary">+ New Company</a>` : ''}
      </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üè¢</div>
        <div class="stat-value">${stats?.totalCompanies || companies?.length || 0}</div>
        <div class="stat-label">Total Companies</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üë•</div>
        <div class="stat-value">${stats?.totalContacts || 0}</div>
        <div class="stat-label">Total Contacts</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üíº</div>
        <div class="stat-value">${stats?.totalDeals || 0}</div>
        <div class="stat-label">Total Deals</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-value">$${formatNumber(stats?.totalValue || 0)}</div>
        <div class="stat-label">Total Value</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-bar">
      <form method="GET" action="/tenant/crm/companies">
        <input type="text" name="search" placeholder="Search companies..." value="${search || ''}">
        <button type="submit" class="btn btn-primary">Search</button>
        ${search ? `<a href="/tenant/crm/companies" class="btn btn-secondary">Clear</a>` : ''}
      </form>
    </div>

    <!-- Companies Grid -->
    ${companies && companies.length > 0 ? `
    <div class="companies-grid">
      ${companies.map(company => `
      <a href="/tenant/crm/companies/${company.id}" class="company-card">
        <div class="company-header">
          <div class="company-avatar">${getInitials(company.name)}</div>
          <div class="company-info">
            <h3>${company.name}</h3>
            ${company.industry ? `<div class="company-industry">${company.industry}</div>` : ''}
          </div>
        </div>

        <div class="company-meta">
          ${company.website ? `
          <div class="meta-item">
            <span class="meta-icon">üåê</span>
            <span class="meta-text">${company.website}</span>
          </div>
          ` : ''}
          ${company.phone ? `
          <div class="meta-item">
            <span class="meta-icon">üìû</span>
            <span class="meta-text">${company.phone}</span>
          </div>
          ` : ''}
          ${company.address ? `
          <div class="meta-item">
            <span class="meta-icon">üìç</span>
            <span class="meta-text">${company.address}${company.city ? ', ' + company.city : ''}</span>
          </div>
          ` : ''}
        </div>

        <div class="company-stats">
          <div class="stat">
            <span class="stat-value">${company._count?.contacts || 0}</span>
            <span class="stat-label">Contacts</span>
          </div>
          <div class="stat">
            <span class="stat-value">${company._count?.deals || 0}</span>
            <span class="stat-label">Deals</span>
          </div>
        </div>

        ${company.notes ? `
        <div class="company-notes">${truncate(company.notes, 100)}</div>
        ` : ''}
      </a>
      `).join('')}
    </div>

    <!-- Pagination -->
    <div class="pagination">
      <a href="?page=${Math.max(1, (page || 1) - 1)}${getQueryString()}" class="btn btn-secondary" ${(page || 1) <= 1 ? 'disabled' : ''}>Previous</a>
      <span>Page ${page || 1}</span>
      <a href="?page=${(page || 1) + 1}${getQueryString()}" class="btn btn-secondary" ${companies.length < (limit || 50) ? 'disabled' : ''}>Next</a>
    </div>
    ` : `
    <div class="empty-state">
      <div class="empty-icon">üè¢</div>
      <p>No companies yet</p>
      ${permissions.includes('crm:create') ? `<a href="/tenant/crm/companies/new" class="btn btn-primary">Create First Company</a>` : ''}
    </div>
    `}

    <script>
      function formatNumber(num) {
        return new Intl.NumberFormat('en-US').format(num);
      }

      function getInitials(name) {
        if (!name) return '?';
        return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
      }

      function truncate(text, length) {
        if (!text) return '';
        return text.length > length ? text.substring(0, length) + '...' : text;
      }

      function getQueryString() {
        const params = new URLSearchParams(window.location.search);
        params.delete('page');
        return params.toString() ? '&' + params.toString() : '';
      }
    </script>

    <style>
      .companies-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .company-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        text-decoration: none;
        color: inherit;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .company-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
      }

      .company-header {
        display: flex;
        gap: 15px;
        align-items: flex-start;
      }

      .company-avatar {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 18px;
        flex-shrink: 0;
      }

      .company-info h3 {
        margin: 0 0 5px 0;
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .company-industry {
        font-size: 13px;
        color: #666;
      }

      .company-meta {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 15px 0;
        border-top: 1px solid #eee;
        border-bottom: 1px solid #eee;
      }

      .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #666;
      }

      .meta-icon {
        font-size: 14px;
      }

      .company-stats {
        display: flex;
        gap: 30px;
      }

      .company-stats .stat {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .company-stats .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: #333;
      }

      .company-stats .stat-label {
        font-size: 12px;
        color: #666;
      }

      .company-notes {
        font-size: 13px;
        color: #666;
        line-height: 1.4;
      }
    </style>
    `
  }) %>
</body>
</html>
